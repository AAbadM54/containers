

## Updating managed add-ons
{: #updating-managed-add-ons}

The versions of each managed add-on are tested by {{site.data.keyword.Bluemix_notm}} and approved for the use in {{site.data.keyword.containerlong_notm}}. To update the components of an add-on to the most recent version supported by {{site.data.keyword.containerlong_notm}}, use the following steps.
{: shortdesc}

To check whether your add-ons are at the latest version, you can run `ibmcloud ks cluster-addon-ls`. Any addons that are denoted with `* (<version> latest)` can be updated.
```
ibmcloud ks cluster-addon-ls --cluster <mycluster>
```
{: pre}

Example output:
```
OK
Name      Version
istio     1.0.5 *(1.0.6 latest)
knative   0.3.0
```
{: screen}

1. Save any resources, such as configuration files for any services or apps, that you created in the namespace that was generated by the add-on. For example, the Istio add-on uses `istio-system`, and the Knative add-on uses `knative-serving`, `knative-monitoring`, `knative-eventing`, and `knative-build`.
  Example command:
  ```
  kubectl get pod <pod_name> -o yaml -n istio-system
  ```
  {: pre}

2. Save the CRD resources for the add-on from the add-on namespaces to a local YAML file. These resources are automatically generated by the custom resource definitions (CRDs) that are included in each add-on.
  1. Get the CRDs for your add-on. For example, for the Istio add-on, get the CRDs from the `istio-system` namespace.
    ```
    kubectl get crd -n istio-system
    ```
    {: pre}

  2. Save any resources created from these CRDs.

3. Optional for Knative: If you modified any of the following resources, save them by running the following command.

  |Resource name|Resource type|Namespace|
  |-------------|-------------|---------|
  |config-autoscaler|ConfigMap|`knative-serving`|
  |config-controller|ConfigMap|`knative-serving`|
  |config-domain|ConfigMap|`knative-serving`|
  |config-gc|ConfigMap|`knative-serving`|
  |config-istio|ConfigMap|`knative-serving`|
  |config-logging|ConfigMap|`knative-serving`|
  |config-network|ConfigMap|`knative-serving`|
  |config-observability|ConfigMap|`knative-serving`|
  |kaniko|BuildTemplate|`knative-serving`|
  |iks-knative-ingress|Ingress|`istio-system`|
  {: caption="Knative resources" caption-side="top"}

  Example command:
  ```
  kubectl get cm config-autoscaler -n knative-serving -o yaml > config-autoscaler.yaml
  ```
  {: pre}

3. Optional for Istio: If you enabled the `istio-sample-bookinfo` and `istio-extras` add-ons, disable them.
  1. Disable the `istio-sample-bookinfo` add-on.
    ```
    ibmcloud ks cluster-addon-disable istio-sample-bookinfo --cluster <cluster_name_or_ID>
    ```
    {: pre}

  2. Disable the `istio-extras` add-on.
    ```
    ibmcloud ks cluster-addon-disable istio-extras --cluster <cluster_name_or_ID>
    ```
    {: pre}

4. Disable the add-on.
  ```
  ibmcloud ks cluster-addon-disable <add-on_name> --cluster <cluster_name_or_ID> -f
  ```
  {: pre}

5. Before continuing to the next step, verify that either resources from the add-on within the add-on namespaces or the add-on namespaces themselves are removed.
  * For example, if you are updating the `istio-extras` add-on, you might verify that the `grafana`, `kiali`, and `jaeger-*` services are removed from the `istio-system` namespace.
    ```
    kubectl get svc -n istio-system
    ```
    {: pre}
  * For example, if you are updating the `knative` add-on, you might verify that the `knative-serving`, `knative-monitoring`, `knative-eventing`, `knative-build`, and `istio-system` namespaces are deleted. The namespaces might have a **STATUS** of `Terminating` for a few minutes before they are completely deleted.
    ```
    kubectl get namespaces -w
    ```
    {: pre}

6. Choose the add-on version that you want to update to.
  ```
  ibmcloud ks addon-versions
  ```
  {: pre}

7. Re-enable the add-on. Use the `--version` flag to specify the version that you want to install. If no version is specified, the default version is installed.
  ```
  ibmcloud ks cluster-addon-enable <add-on_name> --cluster <cluster_name_or_ID> --version <version>
  ```
  {: pre}

8. Apply the CRD resources that you saved in step 2.
  ```
  kubectl apply -f <file_name> -n <namespace>
  ```
  {: pre}

8. Optional for Knative: If you saved any of the resources in step 3, re-apply them.
  Example command:
  ```
  kubectl apply -f config-autoscaler.yaml -n knative-serving
  ```
  {: pre}

9. Optional for Istio: Re-enable the `istio-extras` and `istio-sample-bookinfo` add-ons. Use the same version for these add-ons as the `istio` add-on.
  1. Enable the `istio-extras` add-on.
    ```
    ibmcloud ks cluster-addon-enable istio-extras --cluster <cluster_name_or_ID> --version <version>
    ```
    {: pre}

  2. Enable the `istio-sample-bookinfo` add-on.
    ```
    ibmcloud ks cluster-addon-enable istio-sample-bookinfo --cluster <cluster_name_or_ID> --version <version>
    ```
    {: pre}

<br />


</staging>
