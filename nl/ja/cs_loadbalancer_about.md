---

copyright:
  years: 2014, 2019
lastupdated: "2019-07-31"

keywords: kubernetes, iks, lb2.0, nlb

subcollection: containers

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:pre: .pre}
{:table: .aria-labeledby="caption"}
{:codeblock: .codeblock}
{:tip: .tip}
{:note: .note}
{:important: .important}
{:deprecated: .deprecated}
{:download: .download}
{:preview: .preview}



# NLB について
{: #loadbalancer-about}

標準クラスターを作成すると、{{site.data.keyword.containerlong}} は、ポータブル・パブリック・サブネットとポータブル・プライベート・サブネットを自動的にプロビジョンします。
{: shortdesc}

* ポータブル・パブリック・サブネットでは、5 つの IP アドレスを使用できます。 ポータブル・パブリック IP アドレスの 1 つは、デフォルトの[パブリック Ingress ALB](/docs/containers?topic=containers-ingress) に使用されます。 残りの 4 つのポータブル・パブリック IP アドレスは、パブリック・ネットワーク・ロード・バランサー・サービス (NLB) を作成して単一アプリをインターネットに公開するために使用できます。
* ポータブル・プライベート・サブネットでは、5 つの IP アドレスを使用できます。 ポータブル・プライベート IP アドレスの 1 つは、デフォルトの[プライベート Ingress ALB](/docs/containers?topic=containers-ingress#private_ingress) に使用されます。 残りの 4 つのポータブル・プライベート IP アドレスは、プライベート・ロード・バランサー・サービス (NLB) を作成して単一アプリをプライベート・ネットワークに公開するために使用できます。

ポータブル・パブリック IP アドレスとポータブル・プライベート IP アドレスは静的浮動 IP であり、ワーカー・ノードが削除されても変わりません。 NLB IP アドレスがオンになっているワーカー・ノードが削除されると、IP を常にモニターしている Keepalived デーモンが、IP を自動的に別のワーカー・ノードに移動します。 任意のポートを NLB に割り当てることができます。 NLB は、アプリに対する着信要求のための外部エントリー・ポイントとして機能します。 インターネットから NLB にアクセスするには、NLB のパブリック IP アドレスと割り当てられたポートを、`<IP_address>:<port>` という形式で使用します。 また、ホスト名とともに NLB IP アドレスと登録して NLB の DNS エントリーを作成することもできます。

NLB サービスを使用してアプリを公開した場合、自動的にそのアプリはサービスの NodePort 経由でも使用できるようになります。 [NodePort](/docs/containers?topic=containers-nodeport) には、クラスター内のすべてのワーカー・ノードのすべてのパブリック IP アドレスおよびプライベート IP アドレスでアクセスできます。 NLB を使用しつつ、NodePort へのトラフィックをブロックするには、[ロード・バランサー・サービスまたはノード・ポート・サービスへのインバウンド・トラフィックの制御](/docs/containers?topic=containers-network_policies#block_ingress)を参照してください。

<br />


## バージョン 1.0 と 2.0 の NLB での基本ロード・バランシングと DSR ロード・バランシングの比較
{: #comparison}

NLB の作成時に、基本ロード・バランシングを実行するバージョン 1.0 NLB、または直接サーバー・リターン (DSR) ロード・バランシングを実行するバージョン 2.0 NLB を選択できます。 バージョン 2.0 の NLB はベータ版であるということに注意してください。
{: shortdesc}

**バージョン 1.0 と 2.0 の NLB の類似点は何ですか?**

バージョン 1.0 と 2.0 の NLB はどちらもレイヤー 4 のロード・バランサーであり、Linux カーネル・スペースにあります。どちらのバージョンもクラスター内で実行され、ワーカー・ノードのリソースを使用します。 したがって、NLB の対応能力は常にお客様のクラスターにのみ使用されます。 また、どちらのバージョンの NLB も接続を終了しません。 代わりに、アプリ・ポッドに接続を転送します。

**バージョン 1.0 と 2.0 の NLB の相違点は何ですか?**

クライアントがアプリに要求を送信すると、NLB は、アプリ・ポッドが存在するワーカー・ノードの IP アドレスに要求パケットをルーティングします。 バージョン 1.0 の NLB は、ネットワーク・アドレス変換 (NAT) を使用して、要求パケットのソース IP アドレスを、ロード・バランサー・ポッドが存在するワーカー・ノードの IP に書き換えます。 ワーカー・ノードは、アプリの応答パケットを返すときに、その NLB が存在するワーカー・ノードの IP を使用します。 そして、NLB がクライアントに応答パケットを送信します。 IP アドレスの書き換えを回避するには、[ソース IP 保持を有効にします](/docs/containers?topic=containers-loadbalancer#node_affinity_tolerations)。 ただし、ソース IP 保持を利用するには、要求を別のワーカーに転送しなくてもよいように、ロード・バランサー・ポッドとアプリ・ポッドを同じワーカー上で実行する必要があります。 ノードのアフィニティーと耐障害性をアプリ・ポッドに追加する必要があります。 バージョン 1.0 NLB を使用した基本ロード・バランシングについて詳しくは、[v1.0: 基本ロード・バランシングのコンポーネントとアーキテクチャー](#v1_planning)を参照してください。

バージョン 1.0 の NLB とは異なり、バージョン 2.0 の NLB は、他のワーカー上のアプリ・ポッドに要求を転送する際に NAT を使用しません。 NLB 2.0 は、クライアント要求をルーティングするときに、IP over IP (IPIP) を使用して、元の要求パケットを別のパケットに入れてカプセル化します。このカプセル化された IPIP パケットには、ロード・バランサー・ポッドが存在するワーカー・ノードのソース IP が含まれているので、元の要求パケットはクライアント IP をそのソース IP アドレスとして保持できます。 そして、ワーカー・ノードは、直接サーバー・リターン (DSR) を使用して、アプリの応答パケットをクライアント IP に送信します。 応答パケットは NLB をスキップしてクライアントに直接送信されるので、NLB が処理する必要のあるトラフィックの量が減少します。 バージョン 2.0 NLB を使用した DSR ロード・バランシングについて詳しくは、[v2.0: DSR ロード・バランシングのコンポーネントとアーキテクチャー](#planning_ipvs)を参照してください。

<br />


## NLB 1.0 のコンポーネントおよびアーキテクチャー
{: #v1_planning}

TCP/UDP ネットワーク・ロード・バランサー (NLB) 1.0 は、Linux カーネルの機能である Iptables を使用して、アプリのポッド間で要求の負荷分散を行います。
{: shortdesc}

### 単一ゾーン・クラスター内のトラフィック・フロー
{: #v1_single}

次の図は、NLB 1.0 がインターネットから単一ゾーン・クラスター内のアプリに通信を転送する方法を示しています。
{: shortdesc}

<img src="images/cs_loadbalancer_planning.png" width="410" alt="NLB 1.0 を使用して {{site.data.keyword.containerlong_notm}} のアプリを公開する" style="width:410px; border-style: none"/>

1. アプリに対する要求では、NLB のパブリック IP アドレスとワーカー・ノードに割り当てられたポートを使用します。

2. 要求が、NLB サービスの内部のクラスター IP アドレスとポートに自動的に転送されます。 内部クラスター IP アドレスはクラスター内でのみアクセス可能です。

3. `kube-proxy` が、要求をアプリの NLB サービスにルーティングします。

4. 要求は、アプリ・ポッドのプライベート IP アドレスに転送されます。 要求パッケージのソース IP アドレスが、アプリ・ポッドが実行されているワーカー・ノードのパブリック IP アドレスに変更されます。 複数のアプリ・インスタンスがクラスターにデプロイされている場合、NLB は、アプリ・ポッド間で要求をルーティングします。

### 複数ゾーン・クラスター内のトラフィック・フロー
{: #v1_multi}

次の図は、ネットワーク・ロード・バランサー (NLB) 1.0 がインターネットから複数ゾーン・クラスターのアプリに通信を転送する方法を示しています。
{: shortdesc}

<img src="images/cs_loadbalancer_planning_multizone.png" width="500" alt="複数ゾーン・クラスターでの NLB 1.0 を使用したアプリのロード・バランシング" style="width:500px; border-style: none"/>

デフォルトでは、各 NLB 1.0 が 1 ゾーンにのみセットアップされます。 高可用性を確保するには、アプリ・インスタンスが存在するすべてのゾーンに NLB 1.0 をデプロイする必要があります。 ラウンドロビン・サイクルでさまざまなゾーンの NLB が要求を処理します。 また、各 NLB は、デプロイ先のゾーンのアプリ・インスタンスへの要求と、他のゾーンのアプリ・インスタンスへの要求を転送します。

<br />


## NLB 2.0 (ベータ) のコンポーネントおよびアーキテクチャー
{: #planning_ipvs}

ネットワーク・ロード・バランサー (NLB) 2.0 の機能はベータ版です。 NLB 2.0 を使用するには、[クラスターのマスター・ノードとワーカー・ノードを更新](/docs/containers?topic=containers-update)して Kubernetes バージョン 1.12 以降にする必要があります。
{: note}

NLB 2.0 はレイヤー 4 のロード・バランサーであり、Linux カーネルの IP Virtual Server (IPVS) を使用します。 NLB 2.0 は TCP と UDP をサポートし、複数のワーカー・ノードの前で実行され、IP over IP (IPIP) トンネリングを使用して、単一の NLB IP アドレスに到着するトラフィックをそれらのワーカー・ノードに分散させます。

{{site.data.keyword.containerlong_notm}} で使用できるロード・バランシング・デプロイメント・パターンについて詳細が必要ですか? この[ブログ投稿 ![外部リンク・アイコン](../icons/launch-glyph.svg "外部リンク・アイコン")](https://www.ibm.com/blogs/bluemix/2018/10/ibm-cloud-kubernetes-service-deployment-patterns-for-maximizing-throughput-and-availability/) を確認してください。
{: tip}

### 単一ゾーン・クラスター内のトラフィック・フロー
{: #ipvs_single}

次の図は、NLB 2.0 がインターネットから単一ゾーン・クラスターのアプリに通信を転送する方法を示しています。
{: shortdesc}

<img src="images/cs_loadbalancer_ipvs_planning.png" width="600" alt="バージョン 2.0 の NLB を使用して {{site.data.keyword.containerlong_notm}} 内のアプリを公開する" style="width:600px; border-style: none"/>

1. アプリへのクライアント要求には、NLB のパブリック IP アドレスと、ワーカー・ノードに割り当てられたポートが使用されます。 この例では、NLB の仮想 IP アドレスは 169.61.23.130 であり、この仮想 IP アドレスは現在、ワーカー 10.73.14.25 上にあります。

2. NLB が、クライアント要求パケット (図中の「CR」ラベルが付いたもの) を IPIP パケット (「IPIP」ラベルのもの) の中にカプセル化します。 クライアント要求パケットは、そのソース IP アドレスとしてクライアント IP を保持します。 IPIP カプセル化パケットは、そのソース IP アドレスとしてワーカーの 10.73.14.25 IP を使用します。

3. NLB が、アプリ・ポッドがあるワーカー (10.73.14.26) に IPIP パケットをルーティングします。 複数のアプリ・インスタンスがクラスターにデプロイされている場合、NLB はアプリ・ポッドがデプロイされているワーカー間で要求をルーティングします。

4. ワーカー 10.73.14.26 が、IPIP カプセル化パケットをアンパックしてから、クライアント要求パケットをアンパックします。 そのワーカー・ノード上のアプリ・ポッドにクライアント要求パケットが転送されます。

5. 次に、ワーカー 10.73.14.26 は、元の要求パケットのソース IP アドレス (クライアント IP) を使用して、アプリ・ポッドの応答パケットをクライアントに直接返します。

### 複数ゾーン・クラスター内のトラフィック・フロー
{: #ipvs_multi}

複数ゾーン・クラスター内のトラフィック・フローも、[単一ゾーン・クラスター内のトラフィック](#ipvs_single)と同じパスをたどります。 複数ゾーン・クラスターでは、NLB は自身のゾーン内のアプリ・インスタンスと他のゾーン内のアプリ・インスタンスに要求をルーティングします。 次の図は、各ゾーンに存在するバージョン 2.0 の NLB が、インターネットから複数ゾーン・クラスターのアプリにトラフィックを転送する方法を示しています。
{: shortdesc}

<img src="images/cs_loadbalancer_ipvs_multizone.png" alt="NLB 2.0 を使用して {{site.data.keyword.containerlong_notm}} のアプリを公開する" style="width:500px; border-style: none"/>

デフォルトでは、バージョン 2.0 の各 NLB は、1 つのゾーンにのみセットアップされます。 アプリ・インスタンスが存在するすべてのゾーンにバージョン 2.0 NLB をデプロイすることによって、可用性を高めることができます。
