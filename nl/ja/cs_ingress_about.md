---

copyright:
  years: 2014, 2019
lastupdated: "2019-07-31"

keywords: kubernetes, iks, nginx, ingress controller

subcollection: containers

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:pre: .pre}
{:table: .aria-labeledby="caption"}
{:codeblock: .codeblock}
{:tip: .tip}
{:note: .note}
{:important: .important}
{:deprecated: .deprecated}
{:download: .download}
{:preview: .preview}



# Ingress ALB について
{: #ingress-about}

Ingress は、パブリック要求またはプライベート要求をアプリに転送して、クラスター内のネットワーク・トラフィック・ワークロードを負荷分散させる Kubernetes サービスです。 Ingress を利用すると、固有のパブリック経路またはプライベート経路を使用して複数のアプリ・サービスをパブリック・ネットワークまたはプライベート・ネットワークに公開できます。
{: shortdesc}

## Ingress に含まれるもの
{: #ingress_components}

Ingress は、Ingress リソース、アプリケーション・ロード・バランサー (ALB)、および複数ゾーン・ロード・バランサー (MZLB) の 3 つのコンポーネントで構成されています。
{: shortdesc}

### Ingress リソース
{: #ingress-resource}

Ingress を使用してアプリを公開するには、アプリ用に Kubernetes サービスを作成し、Ingress リソースを定義してそのサービスを Ingress に登録する必要があります。 Ingress リソースは、アプリに対する着信要求を転送する方法についてのルールを定義する Kubernetes リソースです。 また、Ingress リソースによってアプリ・サービスへのパスも指定します。このパスがパブリック経路に付加されて、アプリの固有 URL が形成されます。例えば、`mycluster.us-south.containers.appdomain.cloud/myapp1` のようになります。
{: shortdesc}

公開するアプリを入れる名前空間ごとに 1 つの Ingress リソースが必要です。
* クラスター内のすべてのアプリを同じ名前空間に入れる場合は、そこで公開するアプリのルーティング・ルールを定義するために 1 つの Ingress リソースが必要になります。 同一の名前空間の中の個々のアプリに対して異なるドメインを使用する場合は、ワイルドカード・ドメインを使用して、1 つのリソース内の複数のサブドメイン・ホストを指定することができます。
* クラスター内のアプリを別々の名前空間に入れる場合は、そこで公開するアプリのルールを定義するために、名前空間ごとに 1 つのリソースを作成する必要があります。 ワイルドカード・ドメインを使用し、各 Ingress リソースで別々のサブドメインを指定しなければなりません。

詳しくは、[1 つの名前空間を使用する場合と複数の名前空間を使用する場合のネットワーキングの計画](/docs/containers?topic=containers-ingress#multiple_namespaces)を参照してください。

2018 年 5 月 24 日に、新しいクラスターの Ingress サブドメイン形式が変更されました。 新しいサブドメイン形式に含まれる地域名またはゾーン名は、クラスターが作成されたゾーンに基づいて生成されます。 一貫したアプリのドメイン名にパイプラインが依存している場合は、IBM 提供の Ingress サブドメインの代わりに独自のカスタム・ドメインを使用できます。
{: note}

* 2018 年 5 月 24 日以降に作成されたすべてのクラスターには、新しい形式 `<cluster_name>.<region_or_zone>.containers.appdomain.cloud` のサブドメインが割り当てられます。
* 2018 年 5 月 24 日より前に作成された単一ゾーン・クラスターは、古い形式 `<cluster_name>.<region>.containers.mybluemix.net` で割り当てられたサブドメインを引き続き使用します。
* 初めて[ゾーンをクラスターに追加](/docs/containers?topic=containers-add_workers#add_zone)して、2018 年 5 月 24 日より前に作成された単一ゾーン・クラスターを複数ゾーンに変更した場合も、古い形式 `<cluster_name>.<region>.containers.mybluemix.net` で割り当てられたサブドメインが使用されますが、新しい形式 `<cluster_name>.<region_or_zone>.containers.appdomain.cloud` のサブドメインも割り当てられます。 どちらのサブドメインも使用できます。

### アプリケーション・ロード・バランサー (ALB)
{: #alb-about}

アプリケーション・ロード・バランサー (ALB) は、着信 HTTP、HTTPS、または TCP サービス要求を listen する外部ロード・バランサーです。 そして、ALB は Ingress リソースで定義されたルールに従って、要求を適切なアプリ・ポッドに転送します。
{: shortdesc}

標準クラスターを作成すると、{{site.data.keyword.containerlong_notm}} がそのクラスター用に可用性の高い ALB を自動で作成し、固有のパブリック経路を割り当てます。 パブリック経路は、クラスター作成時にお客様の IBM Cloud インフラストラクチャー・アカウントにプロビジョンされたポータブル・パブリック IP アドレスにリンクされます。 デフォルトのプライベート ALB も自動的に作成されますが、自動的に有効になるわけではありません。

**複数ゾーン・クラスター**: ゾーンをクラスターに追加すると、ポータブル・パブリック・サブネットが追加され、新しいパブリック ALB が自動的に作成されて、そのゾーンのサブネットで有効にされます。 クラスター内のデフォルトのすべてのパブリック ALB は 1 つのパブリック経路を共有しますが、異なる IP アドレスを持っています。 各ゾーンにデフォルトのプライベート ALB も自動的に作成されますが、自動的に有効になるわけではありません。

### 複数ゾーン・ロード・バランサー (MZLB)
{: #mzlb}

**複数ゾーン・クラスター**: 複数ゾーン・クラスターの作成、または[単一ゾーン・クラスターへのゾーンの追加](/docs/containers?topic=containers-add_workers#add_zone)を行うと、必ず、Cloudflare 複数ゾーン・ロード・バランサー (MZLB) が自動的に作成され、地域ごとに 1 つの MZLB が存在するようにデプロイされます。 MZLB は、ALB の IP アドレスを同じサブドメインの背後に配置し、これらの IP アドレスが使用可能かどうかを判別するためにこれらのアドレスに対してヘルス・チェックを有効にします。

例えば、米国東部地域の 3 つのゾーンにワーカー・ノードがある場合、サブドメイン `yourcluster.us-east.containers.appdomain.cloud` には 3 つの ALB IP アドレスがあります。 MZLB は、地域の各ゾーンのパブリック ALB IP をヘルス・チェックし、そのヘルス・チェックに基づいて DNS 参照の結果を最新の状態に保ちます。 例えば、ALB の IP アドレスが `1.1.1.1`、`2.2.2.2`、`3.3.3.3` である場合、Ingress サブドメインの DNS 参照の通常の動作では、3 つの IP がすべて返され、クライアントはそのうちの 1 つにランダムにアクセスします。 IP アドレスが `3.3.3.3` の ALB がゾーンの障害などの理由で使用不可になると、そのゾーンのヘルス・チェックが失敗し、MZLB は障害のある IP をサブドメインから削除し、DNS 参照では正常な `1.1.1.1` および `2.2.2.2` の ALB IP のみが返されます。 サブドメインの存続時間 (TTL) は 30 秒であるため、30 秒後に新しいクライアント・アプリは使用可能で正常な ALB IP の 1 つにのみアクセスできます。

まれに、一部の DNS リゾルバーまたはクライアント・アプリが、30 秒の TTL の後に、正常でない ALB IP を使用し続けることがあります。 これらのクライアント・アプリは、クライアント・アプリが `3.3.3.3` IP を破棄して `1.1.1.1` または `2.2.2.2` への接続を試みるまで、ロード時間が長くなる可能性があります。 クライアント・ブラウザーまたはクライアント・アプリの設定によっては、遅延が数秒からフル TCP タイムアウトの範囲になることがあります。

MZLB は、IBM 提供の Ingress サブドメインのみを使用するパブリック ALB に対してロード・バランシングを行います。 プライベート ALB のみを使用する場合、ALB のヘルスを手動で検査し、DNS 参照の結果を更新する必要があります。 カスタム・ドメインを使用するパブリック ALB を使用する場合は、DNS エントリーに CNAME を作成して、カスタム・ドメインからクラスターの IBM 提供の Ingress サブドメインに要求を転送することで、MZLB ロード・バランシングにパブリック ALB を含めることができます。

Calico preDNAT ネットワーク・ポリシーを使用して Ingress サービスへのすべての着信トラフィックをブロックする場合は、ALB のヘルス・チェックに使用される [Cloudflare の IPv4 IP ![外部リンク・アイコン](../icons/launch-glyph.svg "外部リンク・アイコン")](https://www.cloudflare.com/ips/) をホワイトリストに登録する必要があります。 Calico preDNAT ポリシーを作成してこれらの IP をホワイトリストに登録する手順については、[Calico ネットワーク・ポリシー・チュートリアルのレッスン 3](/docs/containers?topic=containers-policy_tutorial#lesson3) を参照してください。
{: note}

<br />


## IP が Ingress ALB に割り当てられる仕組み
{: #ips}

標準クラスターを作成すると、{{site.data.keyword.containerlong_notm}} は、ポータブル・パブリック・サブネットとポータブル・プライベート・サブネットを自動的にプロビジョンします。 デフォルトでは、クラスターは以下のアドレスを自動的に使用します。
* デフォルトのパブリック Ingress ALB のポータブル・パブリック・サブネット範囲のポータブル・パブリック IP アドレス 1 つ。
* デフォルトのプライベート Ingress ALB のポータブル・プライベート・サブネット範囲のポータブル・プライベート IP アドレス 1 つ。
{: shortdesc}

複数ゾーン・クラスターでは、各ゾーンにデフォルトのパブリック ALB とデフォルトのプライベート ALB が自動的に作成されます。 デフォルトのパブリック ALB の IP アドレスはすべて、クラスター用に IBM から提供された同じサブドメインの背後にあります。

ポータブル・パブリック IP アドレスとポータブル・プライベート IP アドレスは静的浮動 IP であり、ワーカー・ノードが削除されても変わりません。 ワーカー・ノードが削除されると、IP を常にモニターしている `Keepalived` デーモンが、そのワーカーに存在していた ALB ポッドのスケジュールを、そのゾーンの別のワーカー・ノードに自動的に変更します。 スケジュールが変更された ALB ポッドは、同じ静的 IP アドレスをそのまま保持します。 クラスターの存在期間中は、各ゾーンの ALB の IP アドレスは変わりません。 クラスターからゾーンを削除すると、そのゾーンの ALB の IP アドレスは削除されます。

ALB に割り当てられている IP を確認するには、以下のコマンドを実行します。
```
ibmcloud ks albs --cluster <cluster_name_or_id>
```
{: pre}

ゾーンで障害が発生した場合の ALB の IP の動作について詳しくは、[複数ゾーン・ロード・バランサー・コンポーネント](#ingress_components)の定義を参照してください。



<br />


## 単一ゾーン・クラスターで Ingress を使用して要求をアプリに届ける方法
{: #architecture-single}



次の図は、Ingress がインターネットから単一ゾーン・クラスター内のアプリへの通信をどのように誘導するかを示しています。

<img src="images/cs_ingress_singlezone.png" width="800" alt="Ingress を使用して単一ゾーン・クラスターでアプリを公開する方法" style="width:800px; border-style: none"/>

1. ユーザーがアプリの URL にアクセスしてアプリに要求を送信します。 この URL は、Ingress リソース・パスが付加された公開アプリのパブリック URL です (例: `mycluster.us-south.containers.appdomain.cloud/myapp`)。

2. DNS システム・サービスが、URL のサブドメインを、クラスター内の ALB を公開しているロード・バランサーのポータブル・パブリック IP アドレスに解決します。

3. 解決された IP アドレスに基づいて、クライアントが、ALB を公開しているロード・バランサー・サービスに要求を送信します。

4. ロード・バランサー・サービスが、要求を ALB にルーティングします。

5. ALB は、クラスター内の `myapp` パスのルーティング・ルールが存在するかどうかを検査します。 一致するルールが見つかった場合、要求は、Ingress リソースで定義したルールに従って、アプリがデプロイされているポッドに転送されます。 パッケージのソース IP アドレスは、アプリ・ポッドが実行されているワーカー・ノードのパブリック IP アドレスに変更されます。 複数のアプリ・インスタンスがクラスターにデプロイされている場合、ALB は、アプリ・ポッド間で要求のロード・バランシングを行います。

<br />


## 複数ゾーン・クラスターで Ingress を使用して要求をアプリに届ける方法
{: #architecture-multi}

次の図は、Ingress がインターネットから複数ゾーン・クラスター内のアプリへの通信をどのように誘導するかを示しています。

<img src="images/cs_ingress_multizone.png" width="800" alt="Ingress を使用して複数ゾーン・クラスターでアプリを公開する方法" style="width:800px; border-style: none"/>

1. ユーザーがアプリの URL にアクセスしてアプリに要求を送信します。 この URL は、Ingress リソース・パスが付加された公開アプリのパブリック URL です (例: `mycluster.us-south.containers.appdomain.cloud/myapp`)。

2. グローバル・ロード・バランサーとして動作する DNS システム・サービスが、URL のサブドメインを、MZLB から正常なものとして報告された使用可能な IP アドレスに解決します。 MZLB は、クラスター内の各ゾーンでパブリック ALB を公開しているロード・バランサー・サービスのポータブル・パブリック IP アドレスを継続的に確認します。 IP アドレスはラウンドロビン・サイクルで解決されます。これにより、さまざまなゾーンの正常な ALB の間で、要求が等しくロード・バランシングされます。

3. クライアントが、ALB を公開しているロード・バランサー・サービスの IP アドレスに要求を送信します。

4. ロード・バランサー・サービスが、要求を ALB にルーティングします。

5. ALB は、クラスター内の `myapp` パスのルーティング・ルールが存在するかどうかを検査します。 一致するルールが見つかった場合、要求は、Ingress リソースで定義したルールに従って、アプリがデプロイされているポッドに転送されます。 パッケージのソース IP アドレスは、アプリ・ポッドが実行されているワーカー・ノードのパブリック IP アドレスに変更されます。 複数のアプリ・インスタンスがクラスターにデプロイされている場合、ALB はすべてのゾーンのアプリ・ポッド間で要求のロード・バランシングを行います。
