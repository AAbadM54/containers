---

copyright:
  years: 2014, 2018
lastupdated: "2018-08-06"

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:pre: .pre}
{:table: .aria-labeledby="caption"}
{:codeblock: .codeblock}
{:tip: .tip}
{:download: .download}




# 可用性の高い永続ストレージの計画
{: #storage_planning}

## 非永続のデータ・ストレージ・オプション
{: #non_persistent}

データを永続的に保管する必要がない場合や、データをアプリ・インスタンス間で共有する必要がない場合は、非永続ストレージ・オプションを使用できます。 アプリ・コンポーネントの単体テストを行う場合や新機能を試す場合にも非永続ストレージ・オプションを使用できます。
{: shortdesc}

以下のイメージは、{{site.data.keyword.containerlong_notm}} で使用可能な非永続データ・ストレージ・オプションを示しています。 これらの方法は、フリー・クラスターと標準クラスターで使用可能です。
<p>
<img src="images/cs_storage_nonpersistent.png" alt="非永続データ・ストレージ・オプション" width="500" style="width: 500px; border-style: none"/></p>

<table summary="この表は非永続ストレージ・オプションを示しています。行は左から右に読みます。1 列目はオプションの番号、2 列目はオプションの名称、3 列目は説明です。" style="width: 100%">
<caption>非永続のストレージ・オプション</caption>
  <thead>
  <th>オプション</th>
  <th>説明</th>
  </thead>
  <tbody>
    <tr>
      <td>1. コンテナーまたはポッドの内部</td>
      <td>設計上、コンテナーやポッドの存続期間は短く、予期せぬ障害が起こることがあります。 ただし、コンテナーのローカル・ファイル・システムにデータを書き込み、コンテナーのライフサイクルにわたってデータを保管することはできます。 コンテナー内部のデータは、他のコンテナーやポッドと共有できず、コンテナーがクラッシュしたり削除されたりすると失われます。 詳しくは、[Storing data in a container](https://docs.docker.com/storage/) を参照してください。</td>
    </tr>
  <tr>
    <td>2. ワーカー・ノード上</td>
    <td>すべてのワーカー・ノードには 1 次ストレージと 2 次ストレージがセットアップされています。これはワーカー・ノードとして選択したマシン・タイプによって決まります。 1 次ストレージは、オペレーティング・システムのデータの保管に使用され、[Kubernetes <code>hostPath</code> ボリューム ![外部リンク・アイコン](../icons/launch-glyph.svg "外部リンク・アイコン")](https://kubernetes.io/docs/concepts/storage/volumes/#hostpath) を使用してアクセスできます。 2 次ストレージは、`kubelet` およびコンテナー・ランタイム・エンジンからのデータを保管するために使用されます。 2 次ストレージには、[Kubernetes <code>emptyDir</code> ボリューム ![外部リンク・アイコン](../icons/launch-glyph.svg "外部リンク・アイコン")](https://kubernetes.io/docs/concepts/storage/volumes/#emptydir) を使用してアクセスできます。<br/><br/><code>hostPath</code> ボリュームは、ワーカー・ノード・ファイル・システムからポッドにファイルをマウントするために使用されますが、<code>emptyDir</code> は、クラスター内のポッドに割り当てられる空のディレクトリーを作成します。 そのポッド内のすべてのコンテナーは、そのボリュームに対する読み取りと書き込みを行うことができます。 ボリュームは特定の 1 つのポッドに割り当てられるので、レプリカ・セット内の他のポッドとデータを共有することはできません。<br/><br/><p><code>hostPath</code> または <code>emptyDir</code> ボリュームとそのデータは、以下の場合に削除されます。 <ul><li>ワーカー・ノードが削除された場合。</li><li>ワーカー・ノードが再ロードされた、または更新された場合。</li><li>クラスターが削除された場合。</li><li>{{site.data.keyword.Bluemix_notm}} アカウントが一時停止状態になった場合。 </li></ul></p><p>さらに、<code>emptyDir</code> ボリューム内のデータは以下の場合に削除されます。 <ul><li>割り当てられたポッドはワーカー・ノードから永久に削除されます。</li><li>割り当てられたポッドが別のワーカー・ノード上にスケジュールされた場合。</li></ul></p><p><strong>注:</strong> ポッド内のコンテナーがクラッシュした場合でも、ボリューム内のデータはワーカー・ノードで引き続き使用できます。</p></td>
    </tr>
    </tbody>
    </table>


## 高可用性のための永続データ・ストレージ・オプション
{: #persistent}

可用性の高いステートフル・アプリを作成するうえでの主要な課題は、複数のゾーンにある複数のアプリ・インスタンスの間でデータを保持し、常にデータの同期を保つことです。 データの高可用性を実現するためには、マスター・データベースに複数のインスタンスがあり、それらが複数のデータ・センターや複数の地域にも分散している必要があります。 このマスター・データベースは、正しいソースを 1 つのみにするために、継続的に複製される必要があります。 クラスター内のすべてのインスタンスが、このマスター・データベースに対して読み取りと書き込みを行う必要があります。 マスターのいずれかのインスタンスがダウンした場合は、その他のインスタンスがワークロードを引き継ぐため、アプリのダウン時間は発生しません。
{: shortdesc}

以下のイメージは、標準クラスター内のデータの可用性を高めるために {{site.data.keyword.containerlong_notm}} で選択できるオプションを示しています。 どのオプションが適切かは、以下の要因に応じて決まります。
  * **所有しているアプリのタイプ:** 例えば、データをデータベース内ではなくファイル・ベースで保管しなければならないアプリがある場合があります。
  * **データの保管と転送の場所に関する法的要件:** 例えば、法律によってデータの保管と転送が米国内だけに制限されているために、欧州にあるサービスを使用できない場合があります。
  * **バックアップとリストアのオプション:** すべてのストレージ・オプションに、データをバックアップ/リストアするための機能が用意されています。 利用可能なバックアップとリストアのオプションが、バックアップの頻度や、1 次データ・センター外にデータを保管できることなどの、お客様の災害復旧計画の要件を満たしていることを確認してください。
  * **グローバルな複製:** 高可用性を実現するためには、世界中のデータ・センター間に分散され、複製されている複数のストレージ・インスタンスをセットアップすることが推奨されます。

<br/>
<img src="images/cs_storage_mz-ha.png" alt="可用性の高い永続ストレージとしての選択肢"/>

<table summary="この表には永続ストレージの選択肢を示しています。行は左から右に読みます。1 列目は選択肢の番号、2 列目は選択肢のタイトル、3列目は説明です。" style="width: 100%">
<caption>永続ストレージ・オプション</caption>
  <thead>
  <th>オプション</th>
  <th>説明</th>
  </thead>
  <tbody>
  <tr>
  <td>1. NFS または ブロック・ストレージ</td>
  <td>この方法では、Kubernetes 永続ボリュームを使用して、同じゾーン内のアプリやコンテナーのデータを保持できます。</br></br><strong>ファイル・ストレージまたはブロック・ストレージをプロビジョンする方法</strong></br>クラスターにファイル・ストレージとブロック・ストレージをプロビジョンするには、[永続ボリューム (PV) および永続ボリューム請求 (PVC) を使用](cs_storage_basics.html#pvc_pv)します。PVC および PV は、物理的なファイル・ストレージまたはブロック・ストレージ・デバイスをプロビジョンする API を抽象化する Kubernetes の概念です。[動的](cs_storage_basics.html#dynamic_provisioning)または[静的](cs_storage_basics.html#static_provisioning)プロビジョニングを使用して、PVC および PV を作成できます。</br></br><strong>複数ゾーン・クラスターでファイル・ストレージまたはブロック・ストレージを使用できますか?</strong></br> ファイル・ストレージおよびブロック・ストレージ・デバイスは、ゾーンに固有のものであるため、ゾーン間や領域間で共有できません。クラスターでこのタイプのストレージを使用するには、ストレージと同じゾーンに少なくとも 1 つのワーカー・ノードがなければなりません。</br></br>複数のゾーンにまたがるクラスターに、ファイル・ストレージおよびブロック・ストレージを[動的にプロビジョンした](cs_storage_basics.html#dynamic_provisioning)場合、そのストレージはラウンドロビン・ベースで選択された 1 つのゾーンにのみプロビジョンされます。複数ゾーン・クラスターのすべてのゾーンに永続ストレージをプロビジョンするには、ゾーンごとに動的ストレージをプロビジョンする手順を繰り返してください。例えば、ゾーン `dal10`、`dal12`、`dal13` にまたがるクラスターの場合、永続ストレージの最初の動的プロビジョンで、`dal10` にストレージをプロビジョンできます。`dal12` と `dal13` も対象にするために、さらに 2 つの PVC を作成してください。</br></br><strong>ゾーンをまたいでデータを共有するにはどうしたらよいですか?</strong></br>ゾーン間でデータを共有したい場合は、[{{site.data.keyword.cloudant_short_notm}}](/docs/services/Cloudant/getting-started.html#getting-started-with-cloudant) や [{{site.data.keyword.cos_full_notm}}](/docs/services/cloud-object-storage/about-cos.html#about-ibm-cloud-object-storage) などのクラウド・データベース・サービスを使用してください。</td>
  </tr>
  <tr id="cloud-db-service">
    <td>2. Cloud データベース・サービス</td>
    <td>このオプションでは、[IBM Cloudant NoSQL DB](/docs/services/Cloudant/getting-started.html#getting-started-with-cloudant) などの {{site.data.keyword.Bluemix_notm}} データベース・サービスを使用して、データを保持できます。 </br></br><strong>複数ゾーン・クラスターにクラウド・データベース・サービスを使用できますか?</strong></br>クラウド・データベース・サービスを使用する場合、データは、クラスター外部の、指定されたサービス・インスタンスに保管されます。サービス・インスタンスは 1 つのゾーンにプロビジョンされます。ただし、すべてのサービス・インスタンスに、データにアクセスするために使用できる外部インターフェースが用意されています。複数ゾーン・クラスターにデータベース・サービスを使用すると、クラスター、ゾーン、地域をまたいでデータを共有できます。サービス・インスタンスの可用性を高めるために、複数のインスタンスを複数のゾーンに分散させてセットアップし、それらのインスタンス間でレプリケーションすることができます。</br></br><strong>どうしたらクラウド・データベース・サービスを自分のクラスターに追加できますか?</strong></br>クラスター内のサービスを使用するには、クラスター内の名前空間に [{{site.data.keyword.Bluemix_notm}} サービスをバインド](cs_integrations.html#adding_app)する必要があります。 サービスをクラスターにバインドすると、Kubernetes シークレットが作成されます。 Kubernetes シークレットは、サービスへの URL、ユーザー名、およびパスワードなど、サービスに関する機密情報を保持します。 シークレットをシークレット・ボリュームとしてポッドにマウントして、シークレット内の資格情報を使用することによりサービスにアクセスできます。 シークレット・ボリュームを他のポッドにマウントすることにより、ポッド間でデータを共有することもできます。 コンテナーがクラッシュしたとき、またはポッドがワーカー・ノードから削除されたときでも、データは削除されないので、シークレット・ボリュームをマウントした他のポッドから引き続きアクセスできます。 </br></br>{{site.data.keyword.Bluemix_notm}} のデータベース・サービスのほとんどは、少量のデータ用のディスク・スペースを無料で提供しているため、機能をテストすることができます。</p></td>
  </tr>
  <tr>
    <td>3. 社内データベース</td>
    <td>法的な理由でデータをオンサイトに保管しなければならない場合は、オンプレミス・データベースへの [VPN 接続をセットアップ](cs_vpn.html#vpn)し、データ・センター内の既存のストレージ、バックアップと複製のメカニズムを使用できます。</td>
  </tr>
  </tbody>
  </table>

{: caption="表。 Kubernetes クラスターでのデプロイメントのための永続データ・ストレージのオプション" caption-side="top"}
